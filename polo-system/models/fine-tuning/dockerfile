FROM nvidia/cuda:12.4.1-cudnn-runtime-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive \
    PIP_NO_CACHE_DIR=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1


# 1. Python 설치 및 심볼릭 링크
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.10 python3.10-venv python3-pip python3.10-dev git build-essential \
 && ln -sf /usr/bin/python3.10 /usr/bin/python3 \
 && ln -sf /usr/bin/python3 /usr/bin/python \
 && rm -rf /var/lib/apt/lists/*

# 2. 작업 디렉토리
WORKDIR /app

# 3. PyTorch (CUDA 12.1 버전)
RUN python -m pip install --upgrade pip \
 && python -m pip install torch==2.5.1+cu121 torchvision==0.20.1+cu121 torchaudio==2.5.1+cu121 --index-url https://download.pytorch.org/whl/cu121

# 4. accelerate 우선 설치 (transformers 호환용)
RUN python -m pip install accelerate==0.33.0


# 5. 학습 관련 requirements
COPY requirements.train.txt ./requirements.train.txt
RUN python -m pip install -r requirements.train.txt \
    && python -m pip install fastapi uvicorn  # 서빙 패키지

# 6. 학습 코드 복사
COPY training ./training

# 7. 캐시 디렉토리 및 CUDA lib
ENV HF_HOME=/app/.cache/huggingface \
    TRANSFORMERS_CACHE=/app/.cache/huggingface/transformers \
    LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH
